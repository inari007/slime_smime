rcmail.addEventListener("init",function(e){let t=rcmail.gui_objects,i=rcmail.env;"settings"==i.task?(t.mycertslist&&t.othercertslist&&(rcmail.mycertslist=new rcube_list_widget(t.mycertslist,{multiselect:!1,draggable:!1,keyboard:!0}),rcmail.mycertslist.init().focus(),rcmail.othercertslist=new rcube_list_widget(t.othercertslist,{multiselect:!1,draggable:!1,keyboard:!0}),rcmail.othercertslist.init().focus(),$(document).ready(function(){rcmail.slime_certs()}),rcmail.register_command("firstpage",function(){rcmail.slime_change_page(e=>1)}),rcmail.register_command("lastpage",function(){rcmail.slime_change_page(e=>-1)}),rcmail.register_command("previouspage",function(){rcmail.slime_change_page(e=>e-1)}),rcmail.register_command("nextpage",function(){rcmail.slime_change_page(e=>e+1)})),"plugin.slime_settings_section"==rcmail.env.action&&(rcmail.register_command("plugin.slime-cert-import",function(){rcmail.slime_open_import_window()},!0),rcmail.register_command("plugin.slime-import",function(){rcmail.slime_import()},!0),rcmail.register_command("plugin.slime-cert-delete",function(){rcmail.slime_delete()}),rcmail.register_command("plugin.slime-cert-export",function(){rcmail.slime_open_export()}),rcmail.register_command("plugin.slime-option-save",function(){rcmail.slime_save_options()},!0),rcmail.addEventListener("plugin.slime_certificate_password_not_req",function(){rcmail.slime_open_export()}),$(".slime_section_item").on("click",function(){n(this)}),$(".certificates_title").on("click",function(){var e;e=this,$(e).toggleClass("certificates_title_expanded"),"slime_my_certificates_button"==$(e).attr("id")?$("#my_certs-table").toggleClass("hidden"):$("#other_certs-table").toggleClass("hidden")}),$("#slime_options_button").on("click",function(){rcmail.slime_open_options()}),$("#slime_advanced").find("legend:first").on("click",function(){rcmail.slime_open_advanced()}),$("#slime_options_save").prop("disabled",!1),$(".slime_slider_option").on("change",function(){var e;e=this,"slimeenable"==e.id&&(disabled_buttons=!$("#slimesignevery").prop("disabled"),$(".slime_slider_option").not("#slimeenable").prop("disabled",disabled_buttons),$(".slime_options_select").prop("disabled",disabled_buttons))}))):"mail"==i.task&&($(".slime_slider_send").on("change",function(){var e;e=this,"slimedistribute"==e.id&&(disabled_buttons=!$("#slimesign").prop("disabled"),$(".slime_slider_send").not("#slimedistribute").prop("disabled",disabled_buttons))}),$("#slime_menu").find("input,label").mouseup(function(e){e.stopPropagation()}));let s=new MutationObserver(e=>{for(let t of e)"attributes"===t.type&&"class"===t.attributeName&&l(t.target.classList.contains("dark-mode"))});function l(e){e?($("#my_certificates_item").removeClass("slime_smime_my_certificates_item_light").addClass("slime_smime_my_certificates_item_dark"),$("#public_certificates_item").removeClass("slime_smime_public_certificates_item_light").addClass("slime_smime_public_certificates_item_dark"),$("#smime_section").removeClass("smime_section_light").addClass("smime_section_dark"),$(".certificates_title").removeClass("certificates_title_light").addClass("certificates_title_dark")):($("#my_certificates_item").removeClass("slime_smime_my_certificates_item_dark").addClass("slime_smime_my_certificates_item_light"),$("#public_certificates_item").removeClass("slime_smime_public_certificates_item_dark").addClass("slime_smime_public_certificates_item_light"),$("#smime_section").removeClass("smime_section_dark").addClass("smime_section_light"),$(".certificates_title").removeClass("certificates_title_dark").addClass("certificates_title_light"))}function n(e){$(".slime_section_item").not(e).removeClass("selected focused"),$(e).addClass("selected focused")}s.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),l(document.documentElement.classList.contains("dark-mode")),rcube_webmail.prototype.slime_import_attachment=function(e,t){var i=this.set_busy(!0,"loading"),s={_uid:this.env.uid,_attachment:e,_isSignature:t};this.http_post("plugin.slime.import_certificate",s,i)},rcube_webmail.prototype.slime_save_options=function(){settings={_a:"update_settings",_slime_enable:$("#slimeenable").prop("checked"),_slime_sign_every:$("#slimesignevery").prop("checked"),_slime_encrypt_every:$("#slimeencryptevery").prop("checked"),_slime_import_signature:$("#slimeimportsignature").prop("checked"),_slime_import_all:$("#slimeimportevery").prop("checked"),_slime_html_encryption:$("#slimehtmlencryption").prop("checked"),_slime_trust_levels:$("#slimetrustlevels").prop("checked"),_slime_disable_weak:$("#slimedisableweak").prop("checked"),_slime_encryption_algorithm:$("#slime_encryption_algorithm").val()};var e=this.set_busy(!0,"loading");this.http_post("plugin.slime_settings_section",settings,e)},rcube_webmail.prototype.slime_open_export=function(){var e=$(".slime_section_item.selected:first"),t=$(e).hasClass("isOld_True")?"True":"False",i=e.data("extension");if($("#my_certs-table").has(e).length>0)return this.show_popup_dialog(this.get_label("slime_smime.export_msg"),this.get_label("slime_smime.exportcerts"),[{class:"export mainaction",text:this.get_label("slime_smime.export_crt"),click:function(s){rcmail.slime_export(e,"pkcs_crt",null,t,i),$(this).remove()}},{class:"export",text:this.get_label("slime_smime.export_pkcs12"),click:function(s){rcmail.slime_export_password(e,"pkcs_secured",t,i),$(this).remove()}},{class:"cancel",text:this.get_label("close"),click:function(e){$(this).remove()}}],{width:500});rcmail.slime_export(e,"crt",null,t,i)},rcube_webmail.prototype.slime_export=function(e,t,i=null,s,l){var n="certexport-"+new Date().getTime(),r=$("<form>").attr({target:n,method:"post",style:"display:none",action:"?_action=plugin.slime_settings_section&_a=export"}),o=$("<iframe>").attr({name:n,style:"display:none"});r.addClass("slimeExportForm"),r.append($("<input>").attr({name:"_id",value:$(e).attr("id")})),r.append($("<input>").attr({name:"_exportType",value:t})),r.append($("<input>").attr({name:"_isOld",value:s})),r.append($("<input>").attr({name:"_extension",value:l})),null!=i&&r.append($("<input>").attr({name:"_passwd",value:i})),o.appendTo(document.body),r.appendTo(document.body).submit()},rcube_webmail.prototype.slime_export_password=function(e,t,i,s){var l={_a:"export_password",_id:$(e).attr("id"),_exportType:t,_isOld:i,_extension:s},n=this.set_busy(!0,"loading");this.http_post("plugin.slime_settings_section",l,n)},rcube_webmail.prototype.remove_cert=function(){rcmail.slime_certs(),this.enable_command("plugin.slime-cert-delete","plugin.slime-cert-export",!1)},rcube_webmail.prototype.slime_delete=function(){var e=$(".slime_section_item.selected:first"),t=$("#my_certs-table").has(e).length>0?"pkcs12":"crt",i=$(e).hasClass("isOld_True")?"True":"False",s=e.data("extension");this.confirm_dialog(this.get_label("slime_smime.cert_delete_msg"),"delete",function(l,n){var r=n.display_message(n.get_label("slime_smime.cert_delete_title"),"loading"),o={_a:"delete",_id:$(e).attr("id"),_type:t,_isOld:i,_extension:s};n.http_post("plugin.slime_settings_section",o,r)})},rcube_webmail.prototype.slime_add_certs_to_list=function(e){if(!t.othercertslist||!t.mycertslist||!this.mycertslist||!this.othercertslist)return!1;i="crt"==e.type?this.othercertslist:this.mycertslist;var i,s=document.createElement("tr"),l=document.createElement("td");s.id=e.id,s.className="message slime_section_item isOld_"+e.isOld,s.dataset.extension=e.type,l.className="name certItem",l.innerText=e.isUsed?e.name+" ["+this.get_label("slime_smime.used")+"]":e.name,s.appendChild(l),s.addEventListener("click",function(){rcmail.slime_cert_select(this,e.type,e.isOld)}),i.insert_row(s)},rcube_webmail.prototype.slime_certs=function(){if(this.is_framed())return parent.rcmail.slime_certs();var e={_a:"certs",_page:this.env.current_page},t=this.set_busy(!0,"loading");this.mycertslist&&this.mycertslist.clear(!0),this.othercertslist&&this.othercertslist.clear(!0),this.env.current_page||(this.env.current_page=1),this.triggerEvent("listupdate",{list:this.mycertslist}),this.triggerEvent("listupdate",{list:this.othercertslist}),this.http_post("plugin.slime_settings_section",e,t)},rcube_webmail.prototype.slime_change_page=function(e){var t=this.env.current_page,i=this.env.pagecount;let s=e(t);-1==s?s=i:0==s?s=1:i<s&&(s=i),this.env.current_page=s,this.slime_certs()},rcube_webmail.prototype.slime_cert_select=function(e,t,i){var s,l="&_action=plugin.slime_settings_section&_a=info&_id="+$(e).attr("id")+"&_type="+t+"&_isOld="+i;if(s=this.get_frame_window(this.env.contentframe)){if(!l){s.location&&0>s.location.href.indexOf(this.env.blankpage)&&(s.location.href=this.env.blankpage),this.env.frame_lock&&this.set_busy(!1,null,this.env.frame_lock);return}this.env.frame_lock=this.set_busy(!0,"loading"),s.location.href=this.env.comm_path+"&_framed=1"+l}this.enable_command("plugin.slime-cert-delete","plugin.slime-cert-export",!0),n(e)},rcube_webmail.prototype.slime_open_advanced=function(){$("#slime_advanced").find(".collapse:first").toggleClass("show")},rcube_webmail.prototype.slime_open_options=function(){var e;let t="&_action=plugin.slime_settings_section&_a=options";if(e=this.get_frame_window(this.env.contentframe)){if(!t){e.location&&0>e.location.href.indexOf(this.env.blankpage)&&(e.location.href=this.env.blankpage),this.env.frame_lock&&this.set_busy(!1,null,this.env.frame_lock);return}this.env.frame_lock=this.set_busy(!0,"loading"),e.location.href=this.env.comm_path+"&_framed=1"+t}this.enable_command("plugin.slime-cert-delete","plugin.slime-cert-export",!1)},rcube_webmail.prototype.slime_open_import_window=function(){var e=$("<iframe>").attr("src",this.url("plugin.slime_settings_section",{_a:"import",_framed:1})),t=function(t){e[0].contentWindow.rcmail.slime_import()};this.slime_import_dialog=this.simple_dialog(e,"slime_smime.importcerts",t,{button:"import",width:500,height:180})},rcube_webmail.prototype.slime_import=function(){var e=t.importform,i="certimport-"+new Date().getTime(),s=document.getElementById("slimemimportfile");if(s&&!s.value){this.alert_dialog(this.get_label("selectimportfile"));return}var l=this.set_busy(!0,"importwait");return $("<iframe>").attr({name:i,style:"display:none"}).appendTo(document.body),$(e).attr({target:i,action:this.add_url(e.action,"_unlock",l)}).submit(),!0},rcube_webmail.prototype.slime_import_success=function(){(this.slime_import_dialog||parent.rcmail.slime_import_dialog).dialog("destroy")},rcube_webmail.prototype.slime_certificate_password=function(e){var t=this,i="import"==e.type?this.get_label("slime_smime.certificate_protected"):this.get_label("slime_smime.export_password"),s=$('<div class="prompt">'),l=$('<p class="message">').appendTo(s),n=$("<input>").attr({type:"password",size:30,"data-submit":"true"}).appendTo(s);l.text(i),this.show_popup_dialog(s,this.get_label("import"==e.type?"slime_smime.certificate_protected_title":"slime_smime.export_password_title"),[{text:this.get_label("ok"),class:"mainaction save unlock",click:function(i){i.stopPropagation();var s=t.is_framed()?window.parent.$:$,l=n.val();if(!l){n.focus();return}t.slime_password_submit(l,e.type,e.isOld,e.extension),s(this).remove()}},{text:this.get_label("cancel"),class:"cancel",click:function(e){var i=t.is_framed()?window.parent.$:$;e.stopPropagation(),i(this).remove()}}],{width:400})},rcube_webmail.prototype.slime_password_submit=function(e,t,i,s){if("import"==t)return $(this.gui_objects.importform).append($("<input>").attr({type:"hidden",name:"_passwd",value:e})),this.slime_import();var l=$(".slime_section_item.selected:first");rcmail.slime_export(l,"pkcs_secured",e,i,s)}});